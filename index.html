<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Compteur Coinchée — 2000 points</title>
  <style>
    :root{ --bg:#FAF6F2; --card:#FFFFFF; --txt:#2B3640; --muted:#6B7A8C; --border:#E9E5E0; --accent:#466781; --danger:#b94747; }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--txt);font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial}
    .wrap{max-width:920px;margin:24px auto;padding:16px}
    h1{font-size:22px;margin:0 0 12px;font-weight:800}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:14px;margin-bottom:14px;box-shadow:0 6px 18px rgba(0,0,0,.06)}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .row-3{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:10px}
    .row-4{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:10px}
    @media (max-width:720px){ .row,.row-3,.row-4{grid-template-columns:1fr} }
    label{display:block;font-size:12px;color:var(--muted);margin:0 0 6px}
    input[type="text"],input[type="number"],select{width:100%;box-sizing:border-box;background:#fff;border:1px solid var(--border);border-radius:10px;padding:10px 12px;font-size:15px;color:var(--txt);outline:none}
    .btn{appearance:none;border:1px solid var(--border);background:#fff;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer}
    .btn.primary{background:var(--accent);border-color:var(--accent);color:#fff}
    .btn.danger{background:var(--danger);border-color:var(--danger);color:#fff}
    .scores{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:4px}
    .scorebox{border:1px solid var(--border);border-radius:12px;padding:12px;text-align:center;background:#fff}
    .scorebox h3{margin:0 0 4px;font-size:14px;color:#3a4a58}
    .score{font-size:30px;font-weight:800}
    .progress{height:8px;background:#ece7e1;border-radius:999px;overflow:hidden;margin-top:8px}
    .bar{height:100%;background:var(--accent);width:0%}
    table{width:100%;border-collapse:collapse;min-width:620px}
    th,td{border-bottom:1px solid var(--border);padding:10px;font-size:14px}
    th{background:#f7f4f0;text-align:left;color:#354556}
    tr:hover td{background:#faf9f7}
    .right{text-align:right}
    .editable{outline:1px dashed transparent}
    .editable:focus{outline-color:var(--accent); background:#f5f9fc}
    .hint{font-size:12px;color:var(--muted)}
    .scroll{overflow:auto;-webkit-overflow-scrolling:touch}
    .pill{display:inline-block;padding:4px 10px;border:1px solid var(--border);border-radius:999px;font-size:12px;color:#425363;background:#f7fafc}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Compteur Coinchée — 2000 points</h1>

    <!-- Noms des équipes + joueurs -->
    <div class="card">
      <div class="row">
        <div>
          <label>Nom Équipe A</label>
          <input id="teamA" type="text" placeholder="Équipe A">
          <label style="margin-top:8px">Joueurs A (séparés par des virgules)</label>
          <input id="playersA" type="text" placeholder="ex. Alice, Bob">
        </div>
        <div>
          <label>Nom Équipe B</label>
          <input id="teamB" type="text" placeholder="Équipe B">
          <label style="margin-top:8px">Joueurs B (séparés par des virgules)</label>
          <input id="playersB" type="text" placeholder="ex. Chloé, David">
        </div>
      </div>
    </div>

    <!-- Scores -->
    <div class="card">
      <div class="scores">
        <div class="scorebox">
          <h3 id="nameA">Équipe A</h3>
          <div class="score" id="scoreA">0</div>
          <div class="progress"><div class="bar" id="barA"></div></div>
        </div>
        <div class="scorebox">
          <h3 id="nameB">Équipe B</h3>
          <div class="score" id="scoreB">0</div>
          <div class="progress"><div class="bar" id="barB"></div></div>
        </div>
      </div>
    </div>

    <!-- Étape 1 : prise & annonce -->
    <div class="card">
      <div class="row-4">
        <div>
          <label>Preneur</label>
          <select id="preneur">
            <option value="A">Équipe A</option>
            <option value="B">Équipe B</option>
          </select>
        </div>
        <div>
          <label>Couleur (atout)</label>
          <select id="suit">
            <option value="♠">♠ Pique</option>
            <option value="♥">♥ Cœur</option>
            <option value="♦">♦ Carreau</option>
            <option value="♣">♣ Trèfle</option>
          </select>
        </div>
        <div>
          <label>Coinche</label>
          <select id="coinche">
            <option value="1">Aucune (×1)</option>
            <option value="2">Coinchée (×2)</option>
          </select>
        </div>
        <div>
          <label>Annonce (80–160)</label>
          <input id="annonce" type="number" inputmode="numeric" min="0" max="160" step="10" value="0" placeholder="ex. 100">
        </div>
      </div>
      <div class="row" style="margin-top:10px">
        <div>
          <label>Partant (qui commence la donne)</label>
          <select id="starter"><option value="">—</option></select>
        </div>
        <div style="align-self:end">
          <button class="btn primary" id="start">Démarrer la donne</button>
          <span id="current" style="display:none;margin-left:8px" class="pill">
            Donne en cours · <span id="currentTxt"></span>
            <button class="btn" id="cancel" style="margin-left:8px">Annuler</button>
          </span>
        </div>
      </div>
    </div>

    <!-- Étape 2 : points faits -->
    <div class="card">
      <div class="row">
        <div>
          <label>Points faits par le preneur (0–160)</label>
          <input id="scoreFait" type="number" inputmode="numeric" min="0" max="160" placeholder="ex. 100">
        </div>
        <div style="align-self:end">
          <button class="btn primary" id="validate" disabled>Valider les scores</button>
        </div>
      </div>
    </div>

    <!-- Historique -->
    <div class="card">
      <div class="scroll">
        <table id="tbl">
          <thead>
            <tr>
              <th>#</th>
              <th>Détails</th>
              <th class="right" id="thA">A</th>
              <th class="right" id="thB">B</th>
              <th class="right" id="sumA">A</th>
              <th class="right" id="sumB">B</th>
              <th></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div id="winner" style="margin-top:10px"></div>
    </div>

    <!-- Purge totale / reset -->
    <div class="card">
      <button class="btn danger" id="purgeAll">Remettre à zéro & purger le cache</button>
      <div class="hint" style="margin-top:6px">Efface les scores, noms, joueurs et préférences enregistrés dans ce navigateur.</div>
    </div>
  </div>

  <script>
    (function(){
      const $ = s => document.querySelector(s);
      const TARGET = 2000;
      const KEY = 'coinche_clean_v2';
      const els = {
        teamA: $('#teamA'), teamB: $('#teamB'), nameA: $('#nameA'), nameB: $('#nameB'),
        playersA: $('#playersA'), playersB: $('#playersB'),
        thA: $('#thA'), thB: $('#thB'), sumA: $('#sumA'), sumB: $('#sumB'),
        scoreA: $('#scoreA'), scoreB: $('#scoreB'), barA: $('#barA'), barB: $('#barB'),
        preneur: $('#preneur'), suit: $('#suit'), coinche: $('#coinche'), annonce: $('#annonce'), starter: $('#starter'),
        start: $('#start'), current: $('#current'), currentTxt: $('#currentTxt'), cancel: $('#cancel'),
        scoreFait: $('#scoreFait'), validate: $('#validate'),
        tblBody: $('#tbl tbody'), winner: $('#winner'),
        purgeAll: $('#purgeAll')
      };

      const state = { teams:{A:'Équipe A', B:'Équipe B'}, players:{A:[],B:[]}, rounds:[], current:null };

      function save(){ localStorage.setItem(KEY, JSON.stringify(state)); }
      function load(){
        try{ const s = JSON.parse(localStorage.getItem(KEY)||'null'); if(!s) return;
          if(s.teams) state.teams=s.teams;
          if(s.players) state.players=s.players;
          if(Array.isArray(s.rounds)) state.rounds=s.rounds;
        }catch(e){}
      }

      function applyTeamNames(){
        els.teamA.value = state.teams.A; els.teamB.value = state.teams.B;
        els.playersA.value = state.players.A.join(', ');
        els.playersB.value = state.players.B.join(', ');
        els.nameA.textContent = state.teams.A; els.nameB.textContent = state.teams.B;
        els.thA.textContent = state.teams.A; els.thB.textContent = state.teams.B;
        els.sumA.textContent = state.teams.A; els.sumB.textContent = state.teams.B;
        els.preneur.querySelector('option[value="A"]').textContent = state.teams.A;
        els.preneur.querySelector('option[value="B"]').textContent = state.teams.B;
        // Remplit le sélecteur « Partant »
        const opts = ['', ...state.players.A, ...state.players.B]
          .map(n=>`<option value="${n}">${n||'—'}</option>`).join('');
        els.starter.innerHTML = opts;
      }

      function totals(){ let a=0,b=0; for(const r of state.rounds){a+=r.a;b+=r.b;} return {a,b}; }

      function render(){
        applyTeamNames();
        const {a,b} = totals();
        els.scoreA.textContent = a; els.scoreB.textContent = b;
        els.barA.style.width = Math.min(100, Math.round(100*a/TARGET))+'%';
        els.barB.style.width = Math.min(100, Math.round(100*b/TARGET))+'%';

        els.tblBody.innerHTML = '';
        let sa=0,sb=0;
        state.rounds.forEach((r,i)=>{
          sa+=r.a; sb+=r.b;
          const tr=document.createElement('tr');
          tr.innerHTML=`
            <td>${i+1}</td>
            <td>${r.details}</td>
            <td class="right editable" contenteditable="true" data-i="${i}" data-k="a">${r.a}</td>
            <td class="right editable" contenteditable="true" data-i="${i}" data-k="b">${r.b}</td>
            <td class="right">${sa}</td>
            <td class="right">${sb}</td>
            <td><button class="btn danger" data-del="${i}" aria-label="Supprimer">🗑</button></td>`;
          els.tblBody.appendChild(tr);
        });
        // inline edit
        els.tblBody.querySelectorAll('[contenteditable]').forEach(cell=>{
          cell.addEventListener('blur', ()=>{
            const i=parseInt(cell.dataset.i,10), k=cell.dataset.k;
            let v=parseInt(cell.textContent.trim(),10); if(isNaN(v)||v<0) v=0;
            state.rounds[i][k]=v; save(); render();
          });
          cell.addEventListener('keydown',(e)=>{ if(e.key==='Enter'){ e.preventDefault(); cell.blur(); } });
        });
        els.tblBody.querySelectorAll('button[data-del]').forEach(btn=>{
          btn.onclick=()=>{ state.rounds.splice(parseInt(btn.dataset.del,10),1); save(); render(); };
        });

        els.winner.textContent='';
        if(a>=TARGET || b>=TARGET){ els.winner.textContent = (a===b?'Égalité':'Victoire '+(a>b?state.teams.A:state.teams.B)) + ` (${a}–${b})`; }
        save();
      }

      function startHand(){
        const pr=els.preneur.value, suit=els.suit.value;
        let mul=parseInt(els.coinche.value,10)||1;
        const annonce=parseInt(els.annonce.value,10)||0;
        if(annonce<80 || annonce>160){ alert('Entre une annonce valide (80–160).'); return; }
        if(annonce>=160){ mul=1; els.coinche.value='1'; }
        const starter = els.starter.value || '';
        state.current = {pr, suit, mul, annonce, prName: state.teams[pr], starter};
        els.current.style.display='inline-block';
        els.currentTxt.textContent = `${annonce} ${suit} — Preneur ${state.teams[pr]}${mul>1?' — coinché':''}${starter? ' — partant '+starter:''}`;
        els.validate.disabled=false;
        // reset champs
        els.preneur.value='A'; els.suit.value='♠'; els.coinche.value='1'; els.annonce.value='0'; els.starter.value='';
        save(); render();
      }

      function cancelHand(){ state.current=null; els.current.style.display='none'; els.validate.disabled=true; save(); }

      function computeRound(cur, sfRaw){
        const pr=cur.pr, df=(pr==='A'?'B':'A');
        const mul=cur.mul, annonce=cur.annonce, suit=cur.suit, starter=cur.starter||'';
        const sf=Math.max(0, Math.min(160, parseInt(sfRaw,10)||0));
        const tookAll=(sf===160), success=(sf>=annonce);
        const prName=cur.prName;
        let a=0,b=0,details='';

        if(annonce>=160){
          if(tookAll){ const pts=500; if(pr==='A')a=pts; else b=pts; // coinche ignorée
            details=`Capot annoncé ${suit} — Preneur ${prName}${starter? ' — partant '+starter:''}`;
          }else{ const pts=250 + 160; if(df==='A')a=pts; else b=pts;
            details=`Capot annoncé ${suit} — Preneur ${prName}${starter? ' — partant '+starter:''}`;
          }
        }else if(tookAll){
          const pts=250 + annonce; if(pr==='A')a=pts; else b=pts; // pas de coinche sur capot non annoncé
          details=`Capot non annoncé ${suit} — Preneur ${prName}${starter? ' — partant '+starter:''}`;
        }else if(success){
          if(mul>1){ const prPts = annonce*2 + 160; if(pr==='A') a=prPts; else b=prPts; }
          else { const prPts = annonce + sf; if(pr==='A') a=prPts; else b=prPts; }
          const defPts = 160 - sf; if(defPts>0){ if(pr==='A') b+=defPts; else a+=defPts; }
          details=`${annonce} ${suit} — Preneur ${prName}${mul>1?' — coinché':''}${starter? ' — partant '+starter:''}`;
        }else{
          const defPts=160 + annonce; if(df==='A'){ a=defPts; } else { b=defPts; }
          details=`${annonce} ${suit} — Preneur ${prName}${mul>1?' — coinché':''}${starter? ' — partant '+starter:''}`;
        }
        return {a,b,details};
      }

      function addRound(){
        if(!state.current){ alert('Commence par définir la prise, la couleur, le partant et l’annonce (Étape 1).'); return; }
        const sf = els.scoreFait.value;
        if(sf===''){ alert('Entre les points faits par le preneur.'); return; }
        const r = computeRound(state.current, sf);
        state.rounds.push(r);
        state.current=null; els.current.style.display='none'; els.validate.disabled=true; els.scoreFait.value='';
        save(); render();
      }

      // Bindings
      els.teamA.addEventListener('input', ()=>{ state.teams.A=els.teamA.value; save(); render(); });
      els.teamB.addEventListener('input', ()=>{ state.teams.B=els.teamB.value; save(); render(); });
      els.playersA.addEventListener('input', ()=>{ state.players.A=els.playersA.value.split(',').map(s=>s.trim()).filter(Boolean); save(); render(); });
      els.playersB.addEventListener('input', ()=>{ state.players.B=els.playersB.value.split(',').map(s=>s.trim()).filter(Boolean); save(); render(); });
      els.annonce.addEventListener('input', ()=>{ const v=parseInt(els.annonce.value,10)||0; if(v>=160){ els.coinche.value='1'; els.coinche.disabled=true; } else { els.coinche.disabled=false; } });
      els.start.addEventListener('click', startHand);
      els.cancel.addEventListener('click', cancelHand);
      els.validate.addEventListener('click', addRound);
      els.purgeAll.addEventListener('click', ()=>{ if(confirm('Tout effacer et purger le cache du compteur ?')){ localStorage.removeItem(KEY); location.reload(); } });

      // Boot
      load(); render();
    })();
  </script>
</body>
</html>

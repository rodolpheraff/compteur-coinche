<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Belote et Boules</title>
  <style>
    :root{ --bg:#FAF6F2; --card:#FFFFFF; --txt:#2B3640; --muted:#6B7A8C; --border:#E9E5E0; --accent:#466781; --danger:#b94747; }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--txt);font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial}
    .wrap{max-width:920px;margin:24px auto;padding:16px}
    h1{font-size:22px;margin:0 0 12px;font-weight:800}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:14px;margin-bottom:14px;box-shadow:0 6px 18px rgba(0,0,0,.06)}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .row-3{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:10px}
    .row-4{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:10px}
    .row-players{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    @media (max-width:720px){ .row,.row-3,.row-4{grid-template-columns:1fr} }
    label{display:block;font-size:12px;color:var(--muted);margin:0 0 6px}
    .hint{font-size:12px;color:var(--muted)}
    input[type="text"],input[type="number"],select{width:100%;box-sizing:border-box;background:#fff;border:1px solid var(--border);border-radius:10px;padding:10px 12px;font-size:15px;color:#2B3640;outline:none}
    .btn{appearance:none;border:1px solid var(--border);background:#fff;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer}
    .btn.primary{background:var(--accent);border-color:var(--accent);color:#fff}
    .btn.danger{background:var(--danger);border-color:var(--danger);color:#fff}
    .scores{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:4px}
    .scorebox{border:1px solid var(--border);border-radius:12px;padding:12px;text-align:center;background:#fff}
    .scorebox h3{margin:0 0 4px;font-size:14px;color:#3a4a58}
    .score{font-size:30px;font-weight:800}
    .progress{height:8px;background:#ece7e1;border-radius:999px;overflow:hidden;margin-top:8px}
    .bar{height:100%;background:var(--accent);width:0%}

    /* Tableau desktop */
    table{width:100%;border-collapse:collapse;min-width:720px}
    th,td{border-bottom:1px solid var(--border);padding:10px;font-size:14px;vertical-align:top}
    th{background:#f7f4f0;text-align:left;color:#354556}
    tr:hover td{background:#faf9f7}
    .right{text-align:right}
    .editable{outline:1px dashed transparent}
    .editable:focus{outline-color:var(--accent); background:#f5f9fc}
    .scroll{overflow:auto;-webkit-overflow-scrolling:touch}
    .pill{display:inline-block;padding:4px 10px;border:1px solid var(--border);border-radius:999px;font-size:12px;color:#425363;background:#f7fafc}

    /* Aide iOS : s'assurer que le select reste au-dessus et capte bien le tap */
    select { position: relative; z-index: 1; }


    /* Mobile : liste compacte */
    #listMobile{ display:none }
    @media (max-width:720px){
      #tbl{ display:none }
      #listMobile{ display:block }
      .mitem{
        border:1px solid var(--border);
        border-radius:12px;
        background:#fff;
        padding:8px 10px;
        margin-bottom:8px;
      }
      .mrow{ display:flex; align-items:center; gap:8px; flex-wrap:wrap }
      .mrow + .mrow{ margin-top:4px }
      .midx{ color:var(--muted); font-size:12px; min-width:22px; text-align:center }
      .mdetails{
        flex:1; min-width:0; font-size:14px;
        white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      }
      .mbadge{
        display:inline-block; font-size:12px; padding:2px 8px;
        border:1px solid var(--border); border-radius:999px; background:#f7fafc;
      }
      .mscores{
        margin-left:auto; font-variant-numeric:tabular-nums; font-size:13px;
        cursor:pointer; text-decoration:underline;
      }
      .mscores b{ font-weight:800 }
      .mtotals{
        margin-left:auto;
        font-size:12px;
        font-variant-numeric: tabular-nums;
        color:#354556;
        white-space:nowrap;
      }
      .mtotals b{ font-weight:800 }
      .mdelete{ margin-left:auto }
      .mdelete .btn{ padding:6px 10px }
    }

    /* Accordéon */
    .accordion-summary{display:flex;align-items:center;justify-content:space-between;gap:8px}
    .summary-text{font-size:14px;color:#354556}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Belote et Boules</h1>

    <!-- ÉQUIPES & JOUEURS (accordéon) -->
    <div class="card" id="teamsCard">
      <div id="teamsContent">
        <div class="row">
          <div>
            <label for="teamA">Nom Équipe A</label>
            <input id="teamA" type="text" placeholder="Équipe A">
            <label style="margin-top:8px">Joueurs Équipe A</label>
            <div class="row-players">
              <input id="playersA1" type="text" placeholder="A1 (ex. rory)">
              <input id="playersA2" type="text" placeholder="A2 (ex. Bob)">
            </div>
          </div>
          <div>
            <label for="teamB">Nom Équipe B</label>
            <input id="teamB" type="text" placeholder="Équipe B">
            <label style="margin-top:8px">Joueurs Équipe B</label>
            <div class="row-players">
              <input id="playersB1" type="text" placeholder="B1 (ex. Chloé)">
              <input id="playersB2" type="text" placeholder="B2 (ex. David)">
            </div>
          </div>
        </div>
        <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn primary" id="teamsSaveHide">Enregistrer & masquer</button>
        </div>
      </div>

      <div id="teamsSummary" style="display:none">
        <div class="accordion-summary">
          <div class="summary-text" id="teamsSummaryTxt">—</div>
          <div>
            <button class="btn" id="teamsEdit">Modifier</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Scores -->
    <div class="card">
      <div class="scores">
        <div class="scorebox">
          <h3 id="nameA">Équipe A</h3>
          <div class="score" id="scoreA">0</div>
          <div class="progress"><div class="bar" id="barA"></div></div>
        </div>
        <div class="scorebox">
          <h3 id="nameB">Équipe B</h3>
          <div class="score" id="scoreB">0</div>
          <div class="progress"><div class="bar" id="barB"></div></div>
        </div>
      </div>
    </div>

    <!-- Étape 1 : prise & annonce -->
    <div class="card">
      <div class="row-4">
        <div>
          <label for="preneur">Preneur (équipe)</label>
          <select id="preneur">
            <option value="">— Sélectionner —</option>
            <option value="A">Équipe A</option>
            <option value="B">Équipe B</option>
          </select>
          <div class="hint" id="preneurTeamName" style="margin-top:6px">Équipe : —</div>
        </div>
        <div>
          <label for="suit">Couleur (atout)</label>
          <select id="suit">
            <option value="">— Sélectionner —</option>
            <option value="♠">♠ Pique</option>
            <option value="♥">♥ Cœur</option>
            <option value="♦">♦ Carreau</option>
            <option value="♣">♣ Trèfle</option>
          </select>
        </div>
        <div>
          <label for="coinche">Coinche</label>
          <select id="coinche">
            <option value="1">Aucune (×1)</option>
            <option value="2">Coinchée (×2)</option>
          </select>
        </div>
        <div>
          <label for="annonce">Annonce (80–160)</label>
          <input id="annonce" type="number" inputmode="numeric" min="80" max="160" step="10" placeholder="ex. 100">
        </div>
      </div>
      <div class="row" style="margin-top:10px">
        <div>
          <label for="starter">Départ (qui commence la donne)</label>
          <select id="starter"><option value="">— Sélectionner —</option></select>
        </div>
        <div style="align-self:end">
          <button class="btn primary" id="start" disabled>Démarrer la donne</button>
          <span id="current" style="display:none;margin-left:8px" class="pill">
            Donne en cours · <span id="currentTxt"></span>
            <button class="btn" id="cancel" style="margin-left:8px">Annuler</button>
          </span>
        </div>
      </div>
    </div>

    <!-- Étape 2 : points faits -->
    <div class="card">
      <div class="row">
        <div>
          <label for="scoreFait">Points faits par le preneur (0–160)</label>
          <input id="scoreFait" type="number" inputmode="numeric" min="0" max="160" placeholder="ex. 100">
        </div>
        <div style="align-self:end">
          <button class="btn primary" id="validate" disabled>Valider les scores</button>
        </div>
      </div>
    </div>

    <!-- Historique -->
    <div class="card">
      <div class="scroll">
        <table id="tbl">
          <thead>
            <tr>
              <th>#</th>
              <th>Détails</th>
              <th>Départ</th>
              <th class="right" id="thA">A</th>
              <th class="right" id="thB">B</th>
              <th class="right" id="sumA">A</th>
              <th class="right" id="sumB">B</th>
              <th></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>

        <!-- Vue mobile compacte -->
        <div id="listMobile"></div>
      </div>
      <div id="winner" style="margin-top:10px"></div>
    </div>

    <!-- Purge totale / reset -->
    <div class="card">
      <button class="btn danger" id="purgeAll">Remettre à zéro & purger le cache</button>
      <div class="hint" style="margin-top:6px">Efface les scores, noms, joueurs et préférences enregistrés dans ce navigateur.</div>
    </div>
  </div>

  <script>
    (function(){
      const $ = s => document.querySelector(s);
      const TARGET = 2000;
      const KEY = 'coinche_clean_v2';

      const els = {
        // Teams card / accordion
        teamsContent: $('#teamsContent'),
        teamsSummary: $('#teamsSummary'),
        teamsSummaryTxt: $('#teamsSummaryTxt'),
        teamsSaveHide: $('#teamsSaveHide'),
        teamsEdit: $('#teamsEdit'),

        teamA: $('#teamA'), teamB: $('#teamB'),
        nameA: $('#nameA'), nameB: $('#nameB'),
        playersA1: $('#playersA1'), playersA2: $('#playersA2'),
        playersB1: $('#playersB1'), playersB2: $('#playersB2'),

        thA: $('#thA'), thB: $('#thB'), sumA: $('#sumA'), sumB: $('#sumB'),
        scoreA: $('#scoreA'), scoreB: $('#scoreB'), barA: $('#barA'), barB: $('#barB'),
        preneur: $('#preneur'), suit: $('#suit'), coinche: $('#coinche'), annonce: $('#annonce'),
        starter: $('#starter'),
        start: $('#start'), current: $('#current'), currentTxt: $('#currentTxt'), cancel: $('#cancel'),
        scoreFait: $('#scoreFait'), validate: $('#validate'),
        tblBody: $('#tbl tbody'), winner: $('#winner'),
        purgeAll: $('#purgeAll'),
        preneurTeamName: $('#preneurTeamName'),
        listMobile: $('#listMobile')
      };

      const state = {
        teams:{A:'Équipe A', B:'Équipe B'},
        players:{A:['',''], B:['','']},
        rounds:[], // {a,b,starter, pr:'A|B', suit:'♠', annonce:100, mul:1|2}
        current:null,
        ui:{ teamsCollapsed:false }
      };

      function save(){ localStorage.setItem(KEY, JSON.stringify(state)); }

      function load(){
        try{
          const s = JSON.parse(localStorage.getItem(KEY)||'null');
          if(!s) return;
          if(s.teams) state.teams = s.teams;

          // Migration ancien format joueurs
          if(s.players){
            const norm = teamArr => {
              if(Array.isArray(teamArr)) return [(teamArr[0]||'').toString(), (teamArr[1]||'').toString()];
              if(typeof teamArr === 'string'){
                const parts = teamArr.split(',').map(x=>x.trim()).filter(Boolean);
                return [parts[0]||'', parts[1]||''];
              }
              return ['',''];
            };
            state.players.A = norm(s.players.A);
            state.players.B = norm(s.players.B);
          }
          if(Array.isArray(s.rounds)){
            // compat: si ancien objet avait details, on migre
            state.rounds = s.rounds.map(r=>({starter:('starter' in r)? r.starter : '', ...r}));
            migrateOldRounds();
          }
          if(s.ui && typeof s.ui.teamsCollapsed === 'boolean'){
            state.ui.teamsCollapsed = s.ui.teamsCollapsed;
          }
        }catch(e){}
      }

      /* ------- Helpers ------- */
      function teamLabel(key){
        return (key==='A' || key==='B') ? (state.teams[key] || key) : (key || '');
      }
      function teamShort(key){
        const n = (state.teams[key] || key || '').toString().trim();
        if(!n) return key;
        const init = n.normalize('NFD').replace(/[\u0300-\u036f]/g,'')
                     .replace(/[^\p{L}\p{N}\s]/gu,' ')
                     .split(/\s+/).filter(Boolean).slice(0,2)
                     .map(w=>w[0].toUpperCase()).join('');
        return init || key;
      }
      function refreshPreneurLabels(){
        els.preneur.querySelector('option[value="A"]').textContent = teamLabel('A') || 'Équipe A';
        els.preneur.querySelector('option[value="B"]').textContent = teamLabel('B') || 'Équipe B';
        const t = els.preneur.value;
        els.preneurTeamName.textContent = 'Équipe : ' + (t==='A' ? (teamLabel('A')||'—') : t==='B' ? (teamLabel('B')||'—') : '—');
      }
      function refreshStarterOptions(){
        // Si l'utilisateur vient d'ouvrir le select #starter, ne pas le reconstruire
        if (document.activeElement === els.starter) return;

        const t = els.preneur.value; // 'A' / 'B' / ''
        const list = (t==='A'||t==='B') ? (state.players[t]||[]).filter(Boolean) : [];
        const opts = [''].concat(list).map(n=>`<option value="${n}">${n||'— Sélectionner —'}</option>`).join('');
        els.starter.innerHTML = opts;
      }

      function applyTeamNames(){
        els.teamA.value = state.teams.A; els.teamB.value = state.teams.B;

        els.playersA1.value = state.players.A[0]||'';
        els.playersA2.value = state.players.A[1]||'';
        els.playersB1.value = state.players.B[0]||'';
        els.playersB2.value = state.players.B[1]||'';

        $('#nameA').textContent = state.teams.A; $('#nameB').textContent = state.teams.B;
        els.thA.textContent = state.teams.A; els.thB.textContent = state.teams.B;
        els.sumA.textContent = state.teams.A; els.sumB.textContent = state.teams.B;

        // résumé accordéon
        els.teamsSummaryTxt.textContent =
          `${state.teams.A} (${[...state.players.A].filter(Boolean).join(' & ')||'—'})  •  `
          + `${state.teams.B} (${[...state.players.B].filter(Boolean).join(' & ')||'—'})`;

        refreshPreneurLabels();
        refreshStarterOptions();
      }
      function toggleTeams(collapsed){
        state.ui.teamsCollapsed = collapsed;
        els.teamsContent.style.display = collapsed ? 'none' : 'block';
        els.teamsSummary.style.display = collapsed ? 'block' : 'none';
        save();
      }
      function totals(){ let a=0,b=0; for(const r of state.rounds){a+=r.a;b+=r.b;} return {a,b}; }

      // -------- Détails dynamiques (noms d'équipe indépendants) --------
      function detailText(r){
        const prName = teamLabel(r.pr) || r.pr || '?';
        const s  = r.suit || '';
        const an = (typeof r.annonce==='number' && !isNaN(r.annonce)) ? r.annonce : '';
        const x2 = (r.mul && r.mul>1) ? ' ×2' : '';
        if(an>=160) return `Capot annoncé ${s} — Preneur ${prName}`;
        return `${an} ${s}${x2} — Preneur ${prName}`.trim();
      }

      function migrateOldRounds(){
        state.rounds = state.rounds.map(r=>{
          if(r.pr && r.annonce!==undefined && r.suit!==undefined) return r; // déjà au bon format
          const nr = {...r};
          const d = (nr.details||'');
          // preneur
          if(!nr.pr){
            if(/Équipe B/.test(d)) nr.pr='B';
            else if(/Équipe A/.test(d)) nr.pr='A';
            else nr.pr = '';
          }
          // coinche
          if(nr.mul===undefined) nr.mul = /coinch/i.test(d) ? 2 : 1;
          // annonce
          if(nr.annonce===undefined){
            const m = d.match(/(^|\s)(80|90|100|110|120|130|140|150|160)\s/);
            nr.annonce = m ? parseInt(m[2],10) : null;
          }
          // atout
          if(nr.suit===undefined){
            const m = d.match(/[♠♥♦♣]/);
            nr.suit = m ? m[0] : '';
          }
          delete nr.details;
          return nr;
        });
      }

      /* ------- Vue mobile compacte (édition via prompt) ------- */
      function renderMobileHistory(){
        const wrap = els.listMobile;
        if(!wrap) return;
        wrap.innerHTML = '';
        let sa=0, sb=0;
        const sA = teamShort('A'), sB = teamShort('B');
        state.rounds.forEach((r,i)=>{
          sa += r.a; sb += r.b; // cumuls
          const item = document.createElement('div');
          item.className = 'mitem';
          item.innerHTML = `
            <div class="mrow">
              <div class="midx">#${i+1}</div>
              <div class="mdetails">${detailText(r)}</div>
              <div class="mtotals">Σ${sA}:<b>${sa}</b> • Σ${sB}:<b>${sb}</b></div>
            </div>
            <div class="mrow">
              <span class="mbadge">${r.starter ? 'Départ: '+r.starter : 'Départ: —'}</span>
              <span class="mscores" data-i="${i}" title="Modifier les scores de la donne">
                ${sA}:<b>+${r.a}</b> • ${sB}:<b>+${r.b}</b>
              </span>
              <span class="mdelete">
                <button class="btn danger" data-del-mobile="${i}" aria-label="Supprimer">🗑</button>
              </span>
            </div>
          `;
          wrap.appendChild(item);
        });
        // Edition mobile (prompt)
        wrap.querySelectorAll('.mscores').forEach(el=>{
          el.onclick = ()=>{
            const i = parseInt(el.dataset.i,10);
            const r = state.rounds[i];
            const aStr = prompt(`Nouveaux points pour ${teamLabel('A')} (donne #${i+1})`, r.a);
            if(aStr===null) return;
            const bStr = prompt(`Nouveaux points pour ${teamLabel('B')} (donne #${i+1})`, r.b);
            if(bStr===null) return;
            let a = parseInt(aStr,10); let b = parseInt(bStr,10);
            if(isNaN(a)||a<0) a=0;
            if(isNaN(b)||b<0) b=0;
            state.rounds[i].a = a;
            state.rounds[i].b = b;
            save(); render();
          };
        });
        // Suppression mobile
        wrap.querySelectorAll('button[data-del-mobile]').forEach(btn=>{
          btn.onclick = ()=>{
            state.rounds.splice(parseInt(btn.dataset.delMobile,10),1);
            save(); render();
          };
        });
      }

      function render(){
        applyTeamNames();
        toggleTeams(state.ui.teamsCollapsed);

        const {a,b} = totals();
        els.scoreA.textContent = a; els.scoreB.textContent = b;
        els.barA.style.width = Math.min(100, Math.round(100*a/TARGET))+'%';
        els.barB.style.width = Math.min(100, Math.round(100*b/TARGET))+'%';

        // desktop table
        els.tblBody.innerHTML = '';
        let sa=0,sb=0;
        state.rounds.forEach((r,i)=>{
          sa+=r.a; sb+=r.b;
          const tr=document.createElement('tr');
          tr.innerHTML=`
            <td data-label="#">${i+1}</td>
            <td data-label="Détails">${detailText(r)}</td>
            <td data-label="Départ">${r.starter||'—'}</td>
            <td data-label="${state.teams.A}" class="right editable" contenteditable="true" data-i="${i}" data-k="a">${r.a}</td>
            <td data-label="${state.teams.B}" class="right editable" contenteditable="true" data-i="${i}" data-k="b">${r.b}</td>
            <td data-label="Cumul ${state.teams.A}" class="right">${sa}</td>
            <td data-label="Cumul ${state.teams.B}" class="right">${sb}</td>
            <td data-label="Actions" class="td-actions"><button class="btn danger" data-del="${i}" aria-label="Supprimer">🗑</button></td>`;
          els.tblBody.appendChild(tr);
        });
        // inline edit desktop
        els.tblBody.querySelectorAll('[contenteditable]').forEach(cell=>{
          cell.addEventListener('blur', ()=>{
            const i=parseInt(cell.dataset.i,10), k=cell.dataset.k;
            let v=parseInt(cell.textContent.trim(),10); if(isNaN(v)||v<0) v=0;
            state.rounds[i][k]=v; save(); render();
          });
          cell.addEventListener('keydown',(e)=>{ if(e.key==='Enter'){ e.preventDefault(); cell.blur(); } });
        });
        els.tblBody.querySelectorAll('button[data-del]').forEach(btn=>{
          btn.onclick=()=>{ state.rounds.splice(parseInt(btn.dataset.del,10),1); save(); render(); };
        });

        // mobile list
        renderMobileHistory();

        // vainqueur
        els.winner.textContent='';
        if(a>=TARGET || b>=TARGET){
          els.winner.textContent = (a===b?'Égalité':'Victoire '+(a>b?state.teams.A:state.teams.B)) + ` (${a}–${b})`;
        }

        save();
      }

      /* ------- Validation Étape 1 ------- */
      function annonceOK(){
        const v = parseInt(els.annonce.value,10);
        return !isNaN(v) && v>=80 && v<=160;
      }
      function canStart(){
        return (els.preneur.value==='A' || els.preneur.value==='B')
          && (els.suit.value==='♠' || els.suit.value==='♥' || els.suit.value==='♦' || els.suit.value==='♣')
          && annonceOK()
          && (els.starter.value.trim().length>0);
      }
      function updateStartBtn(){
        els.start.disabled = !canStart();
      }

      /* ------- Jeu ------- */
      function startHand(){
        if(!canStart()){
          alert('Complète Preneur, Couleur, Annonce (80–160) et Départ avant de démarrer.');
          return;
        }
        const pr=els.preneur.value, suit=els.suit.value;
        let mul=parseInt(els.coinche.value,10)||1;
        const annonce=parseInt(els.annonce.value,10)||0;
        if(annonce>=160){ mul=1; els.coinche.value='1'; }

        const starter = els.starter.value || '';

        state.current = { pr, suit, mul, annonce, prName: state.teams[pr], starter };

        els.current.style.display='inline-block';
        els.currentTxt.textContent =
          `${annonce} ${suit} — Preneur ${teamLabel(pr)}${mul>1?' — coinché':''}${starter? ' — départ '+starter:''}`;

        els.validate.disabled=false;

        // reset champs (force re-sélection)
        els.preneur.value=''; els.suit.value=''; els.coinche.value='1'; els.annonce.value=''; els.starter.value='';
        refreshPreneurLabels();
        refreshStarterOptions();
        updateStartBtn();

        save(); render();
      }

      function cancelHand(){ state.current=null; els.current.style.display='none'; els.validate.disabled=true; save(); }

      // Calcul des points (structure propre)
      function computeRound(cur, sfRaw){
        const pr=cur.pr, df=(pr==='A'?'B':'A');
        const mul=cur.mul, annonce=cur.annonce, suit=cur.suit, starter=cur.starter||'';
        const sf=Math.max(0, Math.min(160, parseInt(sfRaw,10)||0));
        const tookAll=(sf===160), success=(sf>=annonce);
        let a=0,b=0;

        if(annonce>=160){
          if(tookAll){ const pts=500; if(pr==='A')a=pts; else b=pts; }
          else       { const pts=250 + 160; if(df==='A')a=pts; else b=pts; }
        }else if(tookAll){
          const pts=250 + annonce; if(pr==='A')a=pts; else b=pts;
        }else if(success){
          if(mul>1){ const prPts = annonce*2 + 160; if(pr==='A') a=prPts; else b=prPts; }
          else      { const prPts = annonce + sf;   if(pr==='A') a=prPts; else b=prPts; }
          const defPts = 160 - sf; if(defPts>0){ if(pr==='A') b+=defPts; else a+=defPts; }
        }else{
          const defPts=160 + annonce; if(df==='A'){ a=defPts; } else { b=defPts; }
        }

        return {a,b,starter, pr, suit, annonce, mul};
      }

      function addRound(){
        if(!state.current){ alert('Commence par définir la donne (Étape 1).'); return; }
        const sf = els.scoreFait.value;
        if(sf===''){ alert('Entre les points faits par le preneur.'); return; }
        const r = computeRound(state.current, sf);
        state.rounds.push(r);
        state.current=null; els.current.style.display='none'; els.validate.disabled=true; els.scoreFait.value='';
        save(); render();
      }

      /* ------- Bindings ------- */
      // Accordéon
      $('#teamsSaveHide').addEventListener('click', ()=>{ save(); toggleTeams(true); });
      $('#teamsEdit').addEventListener('click', ()=> toggleTeams(false));

      // Teams / players
      els.teamA.addEventListener('input', ()=>{ state.teams.A=els.teamA.value; save(); render(); });
      els.teamB.addEventListener('input', ()=>{ state.teams.B=els.teamB.value; save(); render(); });

      const syncPlayers = () => {
        state.players.A[0] = els.playersA1.value.trim();
        state.players.A[1] = els.playersA2.value.trim();
        state.players.B[0] = els.playersB1.value.trim();
        state.players.B[1] = els.playersB2.value.trim();
        save();
        refreshStarterOptions();
        render();
      };
      els.playersA1.addEventListener('input', syncPlayers);
      els.playersA2.addEventListener('input', syncPlayers);
      els.playersB1.addEventListener('input', syncPlayers);
      els.playersB2.addEventListener('input', syncPlayers);

      // Sélection preneur / suit / starter / annonce => active le bouton si OK
      els.preneur.addEventListener('change', ()=>{ refreshPreneurLabels(); refreshStarterOptions(); updateStartBtn(); });
      els.suit.addEventListener('change', ()=>{ updateStartBtn(); });
      els.starter.addEventListener('change', ()=>{ updateStartBtn(); });
      els.annonce.addEventListener('input', ()=>{
        const v=parseInt(els.annonce.value,10)||0;
        if(v>=160){ els.coinche.value='1'; els.coinche.disabled=true; } else { els.coinche.disabled=false; }
        updateStartBtn();
      });

      // Actions donne
      els.start.addEventListener('click', startHand);
      els.cancel.addEventListener('click', cancelHand);
      els.validate.addEventListener('click', addRound);

      // Purge
      els.purgeAll.addEventListener('click', ()=>{
        if(confirm('Tout effacer et purger le cache du compteur ?')){
          localStorage.removeItem(KEY); location.reload();
        }
      });
      // --- iOS label→select flicker fix ---
      ['preneur','suit','coinche','starter'].forEach(id=>{
        const sel = document.getElementById(id);
        const lab = document.querySelector(`label[for="${id}"]`);
        if(lab && sel){
          lab.addEventListener('click', (e)=>{
            // Empêche le double "click" label+select (iOS/Chrome iOS)
            e.preventDefault();
            sel.focus();
            // Petit délai pour laisser iOS ouvrir proprement le picker
            setTimeout(()=> sel.click(), 0);
          }, {passive:false});
        }
      });

      // Boot
      load();
      els.preneur.value=''; els.suit.value=''; els.starter.value=''; els.annonce.value='';
      refreshPreneurLabels(); refreshStarterOptions(); updateStartBtn();
      render();
    })();
  </script>
</body>
</html>
